<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PET+CLINIC - Sistem Rekam Medis Veteriner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <style>
        /* --- CSS Kustom untuk Tampilan --- */
        body { background-color: #f4f6f9; }
        .login-page {
            display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f8f9fa;
        }
        .login-container {
            max-width: 900px; width: 100%; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,.1); overflow: hidden; background-color: white;
        }
        .image-side {
            background-color: #e9ecef;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .login-form-side { padding: 40px; }
        .clinic-logo { width: 80px; height: 80px; margin-bottom: 20px; }
        
        /* Dashboard Layout Styling */
        .sidebar {
            width: 250px; background-color: #4c4d9e; position: fixed; height: 100%; padding: 0; color: white; transition: all 0.3s;
        }
        .sidebar .nav-link {
            color: white; padding: 15px 20px; font-size: 1.05rem; border-left: 5px solid transparent;
        }
        .sidebar .nav-link.active,
        .sidebar .nav-link:hover {
            background-color: #6a6baf; border-left: 5px solid #ffffff;
        }
        .sidebar-header {
            padding: 20px; font-size: 1.5rem; font-weight: bold; text-align: center; background-color: #3e3f80;
        }
        .main-content {
            margin-left: 250px; padding: 20px;
        }
        .topbar {
            background-color: white; box-shadow: 0 2px 4px rgba(0,0,0,.05); padding: 15px 20px; margin-bottom: 20px; display: flex; justify-content: flex-end; align-items: center;
        }
        .card-info {
            border-left: 4px solid #4c4d9e;
        }
        .page-content {
            background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,.05);
        }
        .btn-primary-custom {
            background-color: #4c4d9e; border-color: #4c4d9e; color: white;
        }
        .btn-primary-custom:hover {
            background-color: #3e3f80; border-color: #3e3f80; color: white;
        }
    </style>
</head>
<body>

<div id="loginPage" class="login-page">
    <div class="login-container row g-0">
        <div class="image-side col-md-6 d-none d-md-flex flex-column">
            
            <p class="text-center p-4 text-muted">Aplikasi Rekam Medis Veteriner</p>
        </div>
        
        <div class="login-form-side col-md-6">
            <div class="text-center">
                <p class="text-primary fw-bold display-6">Selamat datang di PET+CLINIC</p>
                <p class="text-muted mb-4">Silakan masukkan akun Anda untuk melanjutkan.</p>
            </div>
            
            <form id="loginForm" class="mt-4">
                <div class="mb-3">
                    <label for="username" class="form-label">Username</label>
                    <input type="text" class="form-control" id="username" required>
                </div>
                <div class="mb-4">
                    <label for="password" class="form-label">Password</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary-custom btn-lg">Login</button>
                </div>
                <div id="loginMessage" class="mt-3 text-danger text-center" style="display:none;">
                    Username atau password salah!
                </div>
            </form>
        </div>
    </div>
</div>

<div id="dashboardPage" style="display:none;">
    <div class="sidebar">
        <div class="sidebar-header">
            <span class="d-none d-lg-inline">PET+CLINIC</span>
        </div>
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link" href="#" data-page="dashboard"><i class="bi bi-speedometer2 me-2"></i> Dashboard</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-page="dokter"><i class="bi bi-person-badge me-2"></i> Dokter</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-page="pasien"><i class="bi bi-file-earmark-medical me-2"></i> Input Rekam Medis</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-page="ruang"><i class="bi bi-hospital me-2"></i> Ruang</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-page="rekam-medis"><i class="bi bi-journal-medical me-2"></i> Data Rekam Medis</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" data-page="laporan"><i class="bi bi-file-earmark-bar-graph me-2"></i> Laporan</a>
            </li>
        </ul>
        <div style="position: absolute; bottom: 0; padding: 10px 20px; font-size: 0.8rem; opacity: 0.7;">
            COPYRIGHT © 2021
        </div>
    </div>

    <div class="main-content">
        <div class="topbar">
            <div class="d-flex align-items-center">
                <span class="me-3">admin | Available</span>
                <img src="https://via.placeholder.com/40" alt="Admin" class="rounded-circle">
                <button class="btn btn-sm btn-outline-secondary ms-3" onclick="logout()"><i class="bi bi-box-arrow-right"></i> Logout</button>
            </div>
        </div>
        
        <div id="pageContent" class="page-content">
            </div>
    </div>
</div>

<div class="modal fade" id="rekamMedisModal" tabindex="-1" aria-labelledby="rekamMedisModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="rekamMedisModalLabel">Detail Rekam Medis</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="rekamMedisModalBody">
                </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                <button type="button" class="btn btn-primary-custom" id="modalSaveBtn" style="display: none;">Simpan Perubahan</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="ruangModal" tabindex="-1" aria-labelledby="ruangModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ruangModalLabel">Tambah Ruangan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formRuang" onsubmit="handleRuangSubmit(event)">
                <div class="modal-body">
                    <input type="hidden" id="ruangId">
                    <div class="mb-3">
                        <label for="namaRuang" class="form-label">Nama Ruangan</label>
                        <input type="text" class="form-control" id="namaRuang" required>
                    </div>
                    <div class="mb-3">
                        <label for="kapasitasRuang" class="form-label">Total Kapasitas (Slot)</label>
                        <input type="number" class="form-control" id="kapasitasRuang" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label for="terisiRuang" class="form-label">Jumlah Terisi Saat Ini</label>
                        <input type="number" class="form-control" id="terisiRuang" min="0" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary-custom">Simpan</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const loginPage = document.getElementById('loginPage');
    const dashboardPage = document.getElementById('dashboardPage');
    const pageContent = document.getElementById('pageContent');

    // --- DATA SIMULASI (Pengganti Database) ---
    let dataDokter = JSON.parse(localStorage.getItem('dataDokter')) || [
        { id: 1, nama: "Johan", spesialis: "Hati", alamat: "Karawang", telp: "08987654321" },
    ];
    let dataRekamMedis = JSON.parse(localStorage.getItem('dataRekamMedis')) || [
        { id: 101, tglPeriksa: "2023-03-04", namaPemilik: "Siti", nomorHpPemilik: "0812...", alamatPemilik: "Karawang", namaHewan: "Puss", jenisHewan: "Kucing", rasHewan: "Persia", jenisKelamin: "Betina", umurHewan: "2 th", anamnesa: "Demam tinggi 2 hari.", hr: "120", rr: "40", suhu: "40.1", bb: "3.5", crt: "<2s", mukosa: "Pink pucat", turgor: "Normal", tandaKlinis: "Tidak nafsu makan", diagnosaPasien: "Infeksi virus", keteranganTambahan: "Rawat inap 3 hari.", namaDokter: "Johan", obat: "Bodrex, Dosis: 1/2 tablet", ruang: "Melati 01" },
    ];
    
    // PERBAIKAN: Mengubah struktur dataRuang menjadi array of objects
    let dataRuang = JSON.parse(localStorage.getItem('dataRuang')) || [
        { id: 1, nama: "Melati 01", kapasitas: 5, terisi: 1 },
        { id: 2, nama: "Melati 02", kapasitas: 3, terisi: 3 },
        { id: 3, nama: "Anggrek 01", kapasitas: 10, terisi: 0 },
    ];

    function saveData() {
        localStorage.setItem('dataDokter', JSON.stringify(dataDokter));
        localStorage.setItem('dataRekamMedis', JSON.stringify(dataRekamMedis));
        localStorage.setItem('dataRuang', JSON.stringify(dataRuang)); // Simpan data ruang baru
    }
    
    // --- Logika Login/Logout ---
    document.getElementById('loginForm').addEventListener('submit', function(event) {
        event.preventDefault();

        const usernameInput = document.getElementById('username').value;
        const passwordInput = document.getElementById('password').value;
        const loginMessage = document.getElementById('loginMessage');

        if (usernameInput === 'kelompok3' && passwordInput === 'satuduatiga') {
            loginPage.style.display = 'none';
            dashboardPage.style.display = 'block';
            renderDashboard(); 
        } else {
            loginMessage.style.display = 'block';
        }
    });

    function logout() {
        if(confirm('Apakah Anda yakin ingin logout?')) {
            dashboardPage.style.display = 'none';
            loginPage.style.display = 'flex';
            document.getElementById('loginForm').reset();
            document.getElementById('loginMessage').style.display = 'none';
        }
    }

    // --- UTILITY FUNCTIONS ---
    function setActiveLink(page) {
        document.querySelectorAll('.sidebar .nav-link').forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('data-page') === page) {
                link.classList.add('active');
            }
        });
    }

    // B. Dashboard
    function renderDashboard() {
        const totalPasien = dataRekamMedis.length; 
        const totalDokter = dataDokter.length;
        const totalRuang = dataRuang.length;

        const content = `
            <h2>Dashboard</h2>
            <hr>
            <div class="row">
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card card-info p-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-person-badge display-4 text-primary me-3"></i>
                            <div>
                                <h4 class="mb-0">${totalDokter}</h4>
                                <p class="text-muted mb-0">Dokter</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card card-info p-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-person display-4 text-success me-3"></i>
                            <div>
                                <h4 class="mb-0">${totalPasien}</h4>
                                <p class="text-muted mb-0">Pasien Terdaftar</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card card-info p-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-hospital display-4 text-warning me-3"></i>
                            <div>
                                <h4 class="mb-0">${totalRuang}</h4>
                                <p class="text-muted mb-0">Jenis Ruang</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card card-info p-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-prescription2 display-4 text-danger me-3"></i>
                            <div>
                                <h4 class="mb-0">${totalPasien}</h4>
                                <p class="text-muted mb-0">Jumlah Tindakan/Terapi</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="alert alert-info mt-4">
                Selamat datang kembali di sistem administrasi PET+CLINIC. Data di dashboard disinkronkan.
            </div>
        `;
        pageContent.innerHTML = content;
        setActiveLink('dashboard');
    }

    // C. Dokter (List & CRUD Logic)
    function renderDokter() {
        const content = `
            <div id="dokterList">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2>Dokter</h2>
                    <button class="btn btn-primary-custom" onclick="renderTambahDokter()">
                        <i class="bi bi-plus-lg me-1"></i> Tambah Dokter
                    </button>
                </div>
                <hr>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Nama</th>
                                <th>Spesialis</th>
                                <th>Alamat</th>
                                <th>Nomor Telepon</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${dataDokter.map((d, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${d.nama}</td>
                                    <td>${d.spesialis}</td>
                                    <td>${d.alamat}</td>
                                    <td>${d.telp}</td>
                                    <td>
                                        <button class="btn btn-sm btn-info text-white" onclick="renderTambahDokter(${d.id})"><i class="bi bi-pencil"></i> Edit</button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteDokter(${d.id})"><i class="bi bi-trash"></i> Hapus</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        pageContent.innerHTML = content;
        setActiveLink('dokter');
    }

    function renderTambahDokter(idToEdit = null) {
        const dokter = idToEdit ? dataDokter.find(d => d.id === idToEdit) : {};
        const isEdit = !!idToEdit;

        const form = `
            <h2>${isEdit ? 'Edit' : 'Tambah'} Dokter</h2>
            <hr>
            <form id="formDokter" onsubmit="handleDokterSubmit(event, ${idToEdit})">
                <div class="mb-3">
                    <label for="namaDokter" class="form-label">Nama</label>
                    <input type="text" class="form-control" id="namaDokter" value="${dokter.nama || ''}" required>
                </div>
                <div class="mb-3">
                    <label for="nomorHpDokter" class="form-label">Nomor HP</label>
                    <input type="tel" class="form-control" id="nomorHpDokter" value="${dokter.telp || ''}" required>
                </div>
                <div class="mb-3">
                    <label for="alamatDokter" class="form-label">Alamat</label>
                    <textarea class="form-control" id="alamatDokter" rows="3" required>${dokter.alamat || ''}</textarea>
                </div>
                <div class="mb-4">
                    <label for="spesialisDokter" class="form-label">Spesialis</label>
                    <input type="text" class="form-control" id="spesialisDokter" value="${dokter.spesialis || ''}" required>
                </div>
                
                <button type="submit" class="btn btn-primary-custom me-2">${isEdit ? 'Simpan Perubahan' : 'Simpan'}</button>
                <button type="button" class="btn btn-secondary" onclick="renderDokter()">Kembali</button>
            </form>
        `;
        pageContent.innerHTML = form;
    }

    function handleDokterSubmit(event, idToEdit) {
        event.preventDefault();
        const nama = document.getElementById('namaDokter').value;
        const telp = document.getElementById('nomorHpDokter').value;
        const alamat = document.getElementById('alamatDokter').value;
        const spesialis = document.getElementById('spesialisDokter').value;

        if (idToEdit) {
            const index = dataDokter.findIndex(d => d.id === idToEdit);
            if (index !== -1) {
                dataDokter[index] = { ...dataDokter[index], nama, telp, alamat, spesialis };
            }
            alert("Data Dokter berhasil diubah!");
        } else {
            const newId = dataDokter.length > 0 ? Math.max(...dataDokter.map(d => d.id)) + 1 : 1;
            dataDokter.push({ id: newId, nama, telp, alamat, spesialis });
            alert("Data Dokter berhasil ditambahkan!");
        }
        
        saveData();
        renderDokter();
    }

    function deleteDokter(id) {
        if (confirm("Apakah Anda yakin ingin menghapus data Dokter ini?")) {
            dataDokter = dataDokter.filter(d => d.id !== id);
            saveData();
            renderDokter();
            renderDashboard();
            alert("Data Dokter berhasil dihapus.");
        }
    }


    // D. Input Rekam Medis (Pasien)
    function renderPasien() {
        const content = `
            <h2>Input Rekam Medis Baru</h2>
            <hr>
            <form id="formTambahRekamMedis" onsubmit="handleRekamMedisSubmit(event)">
                
                <h4 class="mt-4 mb-3">Data Pemilik & Jadwal</h4>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="namaPemilik" class="form-label">Nama Pemilik</label>
                        <input type="text" class="form-control" id="namaPemilik" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="nomorHpPemilik" class="form-label">Nomor HP</label>
                        <input type="tel" class="form-control" id="nomorHpPemilik" required>
                    </div>
                    <div class="col-12 mb-3">
                        <label for="alamatPemilik" class="form-label">Alamat</label>
                        <textarea class="form-control" id="alamatPemilik" rows="2" required></textarea>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="tanggalPeriksa" class="form-label">Tanggal Hewan Periksa</label>
                        <input type="date" class="form-control" id="tanggalPeriksa" value="${new Date().toISOString().substring(0, 10)}" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="namaDokter" class="form-label">Dokter Pemeriksa</label>
                        <select class="form-select" id="namaDokter" required>
                            <option value="">Pilih Dokter</option>
                            ${dataDokter.map(d => `<option value="${d.nama}">${d.nama} (${d.spesialis})</option>`).join('')}
                        </select>
                    </div>
                </div>

                <h4 class="mt-4 mb-3">Data Hewan</h4>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="namaHewan" class="form-label">Nama Hewan</label>
                        <input type="text" class="form-control" id="namaHewan" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="jenisHewan" class="form-label">Jenis Hewan</label>
                        <input type="text" class="form-control" id="jenisHewan" placeholder="Contoh: Kucing/Anjing" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="rasHewan" class="form-label">Ras Hewan</label>
                        <input type="text" class="form-control" id="rasHewan">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="jenisKelamin" class="form-label">Jenis Kelamin</label>
                        <select class="form-select" id="jenisKelamin" required>
                            <option value="">Pilih...</option>
                            <option>Jantan</option>
                            <option>Betina</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="umurHewan" class="form-label">Umur Hewan</label>
                        <input type="text" class="form-control" id="umurHewan" placeholder="Contoh: 1 tahun 3 bulan">
                    </div>
                    <div class="col-12 mb-3">
                        <label for="anamnesa" class="form-label">Anamnesa (Keluhan Utama)</label>
                        <textarea class="form-control" id="anamnesa" rows="3" required></textarea>
                    </div>
                </div>

                <h4 class="mt-4 mb-3">Pemeriksaan Fisik</h4>
                <div class="row">
                    <div class="col-md-3 mb-3"> <label for="hr" class="form-label">Heart Rate (HR)</label> <input type="text" class="form-control" id="hr"> </div>
                    <div class="col-md-3 mb-3"> <label for="rr" class="form-label">Respiration Rate (RR)</label> <input type="text" class="form-control" id="rr"> </div>
                    <div class="col-md-3 mb-3"> <label for="suhu" class="form-label">Suhu (°C)</label> <input type="number" step="0.1" class="form-control" id="suhu"> </div>
                    <div class="col-md-3 mb-3"> <label for="bb" class="form-label">Berat Badan (BB) (kg)</label> <input type="number" step="0.1" class="form-control" id="bb"> </div>
                    <div class="col-md-3 mb-3"> <label for="crt" class="form-label">CRT (Capillary Refill Time)</label> <input type="text" class="form-control" id="crt"> </div>
                    <div class="col-md-3 mb-3"> <label for="mukosa" class="form-label">Mukosa</label> <input type="text" class="form-control" id="mukosa"> </div>
                    <div class="col-md-3 mb-3"> <label for="turgor" class="form-label">Turgor Kulit</label> <input type="text" class="form-control" id="turgor"> </div>
                    <div class="col-md-3 mb-3"> <label for="tandaKlinis" class="form-label">Tanda Klinis Lain</label> <input type="text" class="form-control" id="tandaKlinis"> </div>
                </div>

                <h4 class="mt-4 mb-3">Diagnosa & Tindakan</h4>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="diagnosaPasien" class="form-label">Diagnosa</label>
                        <textarea class="form-control" id="diagnosaPasien" rows="2" required></textarea>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="obatPasien" class="form-label">Obat/Terapi yang Diberikan (Dosis & Keterangan)</label>
                        <textarea class="form-control" id="obatPasien" rows="2"></textarea>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="ruangRawat" class="form-label">Ruang Rawat (Jika Perlu)</label>
                        <select class="form-select" id="ruangRawat">
                            <option value="">Tidak Dirawat</option>
                            ${dataRuang.map(r => `<option value="${r.nama}">${r.nama} (Slot Tersedia: ${r.kapasitas - r.terisi})</option>`).join('')}
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="keteranganTambahan" class="form-label">Keterangan Tambahan</label>
                        <textarea class="form-control" id="keteranganTambahan" rows="2"></textarea>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary-custom me-2 mt-3">Simpan Rekam Medis</button>
            </form>
        `;
        pageContent.innerHTML = content;
        setActiveLink('pasien');
    }

    function handleRekamMedisSubmit(event) {
        event.preventDefault();

        const form = event.target;
        const newRecord = {
            id: dataRekamMedis.length > 0 ? Math.max(...dataRekamMedis.map(r => r.id)) + 1 : 101,
            tglPeriksa: form.tanggalPeriksa.value,
            namaPemilik: form.namaPemilik.value,
            nomorHpPemilik: form.nomorHpPemilik.value,
            alamatPemilik: form.alamatPemilik.value,
            namaHewan: form.namaHewan.value,
            jenisHewan: form.jenisHewan.value,
            rasHewan: form.rasHewan.value,
            jenisKelamin: form.jenisKelamin.value,
            umurHewan: form.umurHewan.value,
            anamnesa: form.anamnesa.value,
            hr: form.hr.value,
            rr: form.rr.value,
            suhu: form.suhu.value,
            bb: form.bb.value,
            crt: form.crt.value,
            mukosa: form.mukosa.value,
            turgor: form.turgor.value,
            tandaKlinis: form.tandaKlinis.value,
            diagnosaPasien: form.diagnosaPasien.value,
            keteranganTambahan: form.keteranganTambahan.value,
            namaDokter: form.namaDokter.value,
            obat: form.obatPasien.value,
            ruang: form.ruangRawat.value,
        };

        // PERBAIKAN: Logika penambahan slot terisi jika memilih Ruang Rawat
        if (newRecord.ruang) {
            const ruangIndex = dataRuang.findIndex(r => r.nama === newRecord.ruang);
            if (ruangIndex !== -1 && dataRuang[ruangIndex].terisi < dataRuang[ruangIndex].kapasitas) {
                dataRuang[ruangIndex].terisi += 1;
            } else if (ruangIndex !== -1) {
                alert(`Peringatan: Ruang ${newRecord.ruang} sudah penuh. Rekam Medis tetap disimpan, tetapi status ruangan tidak diubah.`);
            }
        }


        dataRekamMedis.push(newRecord);
        saveData();
        renderDashboard();
        form.reset();
        alert("Rekam Medis baru berhasil disimpan!");
        renderRekamMedis();
    }

    // E. Data Rekam Medis (List & CRUD Logic)
    function renderRekamMedis() {
        const content = `
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>Data Rekam Medis</h2>
                <button class="btn btn-primary-custom" onclick="renderPasien()">
                    <i class="bi bi-plus-lg me-1"></i> Tambah Rekam Medis
                </button>
            </div>
            <hr>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Tgl Periksa</th>
                            <th>Nama Pemilik</th>
                            <th>Nama Hewan</th>
                            <th>Jenis Hewan</th>
                            <th>Diagnosa</th>
                            <th>Dokter</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${dataRekamMedis.map((rm) => `
                            <tr>
                                <td>${rm.tglPeriksa}</td>
                                <td>${rm.namaPemilik}</td>
                                <td>${rm.namaHewan}</td>
                                <td>${rm.jenisHewan}</td>
                                <td>${rm.diagnosaPasien}</td>
                                <td>${rm.namaDokter}</td>
                                <td>
                                    <button class="btn btn-sm btn-info text-white" onclick="viewRekamMedisDetail(${rm.id}, true)"><i class="bi bi-pencil"></i> Edit</button>
                                    <button class="btn btn-sm btn-secondary" onclick="viewRekamMedisDetail(${rm.id}, false)"><i class="bi bi-eye"></i> Detail</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteRekamMedis(${rm.id})"><i class="bi bi-trash"></i> Hapus</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        pageContent.innerHTML = content;
        setActiveLink('rekam-medis');
    }

    function viewRekamMedisDetail(id, isEdit) {
        const record = dataRekamMedis.find(r => r.id === id);
        if (!record) return alert("Data tidak ditemukan.");

        const doctorOptions = dataDokter.map(d => 
            `<option value="${d.nama}" ${record.namaDokter === d.nama ? 'selected' : ''}>${d.nama} (${d.spesialis})</option>`
        ).join('');
        
        // Membangun opsi ruangan dengan status kapasitas
        const ruangOptions = dataRuang.map(r => {
            const status = r.kapasitas > r.terisi ? `(Slot Tersedia: ${r.kapasitas - r.terisi})` : `(Penuh)`;
            const isDisabled = !isEdit && r.nama !== record.ruang ? 'disabled' : ''; // Hanya disable jika bukan mode edit dan bukan ruangan yang saat ini dipakai
            const isSelected = record.ruang === r.nama ? 'selected' : '';
            return `<option value="${r.nama}" ${isSelected} ${isDisabled}>${r.nama} ${status}</option>`;
        }).join('');
        
        const disabled = isEdit ? '' : 'disabled';

        // Konten Modal (HTML Form yang sama dengan input pasien, tapi diisi data)
        const modalBodyContent = `
            <form id="formEditRekamMedis" data-id="${id}">
                <h5 class="mt-2 mb-3 text-primary">${isEdit ? 'Mode Edit' : 'Mode Lihat Detail'}</h5>
                
                <h6>Data Umum</h6>
                <div class="row">
                    <div class="col-md-6 mb-3"><label class="form-label">Tanggal Periksa</label><input type="date" class="form-control" id="modal_tglPeriksa" value="${record.tglPeriksa}" ${disabled}></div>
                    <div class="col-md-6 mb-3"><label class="form-label">Dokter</label><select class="form-select" id="modal_namaDokter" ${disabled}><option value="">Pilih Dokter</option>${doctorOptions}</select></div>
                    <div class="col-md-6 mb-3"><label class="form-label">Nama Pemilik</label><input type="text" class="form-control" id="modal_namaPemilik" value="${record.namaPemilik}" ${disabled}></div>
                    <div class="col-md-6 mb-3"><label class="form-label">Nomor HP</label><input type="tel" class="form-control" id="modal_nomorHpPemilik" value="${record.nomorHpPemilik}" ${disabled}></div>
                    <div class="col-12 mb-3"><label class="form-label">Alamat Pemilik</label><textarea class="form-control" id="modal_alamatPemilik" rows="2" ${disabled}>${record.alamatPemilik}</textarea></div>
                </div>

                <h6>Data Hewan & Anamnesa</h6>
                <div class="row">
                    <div class="col-md-4 mb-3"><label class="form-label">Nama Hewan</label><input type="text" class="form-control" id="modal_namaHewan" value="${record.namaHewan}" ${disabled}></div>
                    <div class="col-md-4 mb-3"><label class="form-label">Jenis Hewan</label><input type="text" class="form-control" id="modal_jenisHewan" value="${record.jenisHewan}" ${disabled}></div>
                    <div class="col-md-4 mb-3"><label class="form-label">Ras Hewan</label><input type="text" class="form-control" id="modal_rasHewan" value="${record.rasHewan}" ${disabled}></div>
                    <div class="col-md-4 mb-3"><label class="form-label">J. Kelamin</label><input type="text" class="form-control" id="modal_jenisKelamin" value="${record.jenisKelamin}" ${disabled}></div>
                    <div class="col-md-4 mb-3"><label class="form-label">Umur Hewan</label><input type="text" class="form-control" id="modal_umurHewan" value="${record.umurHewan}" ${disabled}></div>
                    <div class="col-12 mb-3"><label class="form-label">Anamnesa (Keluhan)</label><textarea class="form-control" id="modal_anamnesa" rows="3" ${disabled}>${record.anamnesa}</textarea></div>
                </div>
                
                <h6>Pemeriksaan Fisik</h6>
                <div class="row">
                    <div class="col-md-3 mb-3"><label class="form-label">HR</label><input type="text" class="form-control" id="modal_hr" value="${record.hr}" ${disabled}></div>
                    <div class="col-md-3 mb-3"><label class="form-label">RR</label><input type="text" class="form-control" id="modal_rr" value="${record.rr}" ${disabled}></div>
                    <div class="col-md-3 mb-3"><label class="form-label">Suhu</label><input type="text" class="form-control" id="modal_suhu" value="${record.suhu}" ${disabled}></div>
                    <div class="col-md-3 mb-3"><label class="form-label">BB</label><input type="text" class="form-control" id="modal_bb" value="${record.bb}" ${disabled}></div>
                    <div class="col-md-3 mb-3"><label class="form-label">CRT</label><input type="text" class="form-control" id="modal_crt" value="${record.crt}" ${disabled}></div>
                    <div class="col-md-3 mb-3"><label class="form-label">Mukosa</label><input type="text" class="form-control" id="modal_mukosa" value="${record.mukosa}" ${disabled}></div>
                    <div class="col-md-3 mb-3"><label class="form-label">Turgor</label><input type="text" class="form-control" id="modal_turgor" value="${record.turgor}" ${disabled}></div>
                    <div class="col-md-3 mb-3"><label class="form-label">Tanda Klinis</label><input type="text" class="form-control" id="modal_tandaKlinis" value="${record.tandaKlinis}" ${disabled}></div>
                </div>

                <h6>Diagnosa & Tindakan</h6>
                <div class="row">
                    <div class="col-md-6 mb-3"><label class="form-label">Diagnosa</label><textarea class="form-control" id="modal_diagnosaPasien" rows="2" ${disabled}>${record.diagnosaPasien}</textarea></div>
                    <div class="col-md-6 mb-3"><label class="form-label">Obat/Terapi</label><textarea class="form-control" id="modal_obatPasien" rows="2" ${disabled}>${record.obat}</textarea></div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Ruang Rawat</label>
                        <select class="form-select" id="modal_ruangRawat" ${disabled}>
                            <option value="">Tidak Dirawat</option>
                            ${ruangOptions}
                        </select>
                    </div>
                    <div class="col-md-6 mb-3"><label class="form-label">Keterangan Tambahan</label><textarea class="form-control" id="modal_keteranganTambahan" rows="2" ${disabled}>${record.keteranganTambahan}</textarea></div>
                </div>
            </form>
        `;

        document.getElementById('rekamMedisModalLabel').textContent = isEdit ? 'Edit Rekam Medis #' + id : 'Detail Rekam Medis #' + id;
        document.getElementById('rekamMedisModalBody').innerHTML = modalBodyContent;
        document.getElementById('modalSaveBtn').style.display = isEdit ? 'block' : 'none';

        if (isEdit) {
            // Simpan ruang lama sebelum edit
            document.getElementById('modalSaveBtn').onclick = () => saveRekamMedisEdit(id, record.ruang);
        }

        const modal = new bootstrap.Modal(document.getElementById('rekamMedisModal'));
        modal.show();
    }

    function saveRekamMedisEdit(id, oldRuang) {
        const index = dataRekamMedis.findIndex(r => r.id === id);
        if (index === -1) return;

        const form = document.getElementById('formEditRekamMedis');
        const newRuang = form.modal_ruangRawat.value;

        // PERBAIKAN: Logika update status ruangan
        if (oldRuang && oldRuang !== newRuang) {
            // Kurangi slot ruang lama
            const oldRuangIndex = dataRuang.findIndex(r => r.nama === oldRuang);
            if (oldRuangIndex !== -1) {
                dataRuang[oldRuangIndex].terisi = Math.max(0, dataRuang[oldRuangIndex].terisi - 1);
            }
        }

        if (newRuang && newRuang !== oldRuang) {
            // Tambah slot ruang baru
            const newRuangIndex = dataRuang.findIndex(r => r.nama === newRuang);
            if (newRuangIndex !== -1 && dataRuang[newRuangIndex].terisi < dataRuang[newRuangIndex].kapasitas) {
                dataRuang[newRuangIndex].terisi += 1;
            } else if (newRuangIndex !== -1) {
                alert(`Peringatan: Ruang ${newRuang} sudah penuh. Rekam Medis tetap diupdate, tetapi status ruangan tidak diubah.`);
            }
        }
        
        // Update data rekam medis
        dataRekamMedis[index] = {
            ...dataRekamMedis[index],
            tglPeriksa: form.modal_tglPeriksa.value,
            namaPemilik: form.modal_namaPemilik.value,
            // ... (update semua field lainnya)
            anamnesa: form.modal_anamnesa.value,
            diagnosaPasien: form.modal_diagnosaPasien.value,
            namaDokter: form.modal_namaDokter.value,
            obat: form.modal_obatPasien.value,
            ruang: newRuang, // Gunakan newRuang
            // ... (lanjutkan update field lainnya)
            nomorHpPemilik: form.modal_nomorHpPemilik.value,
            alamatPemilik: form.modal_alamatPemilik.value,
            namaHewan: form.modal_namaHewan.value,
            jenisHewan: form.modal_jenisHewan.value,
            rasHewan: form.modal_rasHewan.value,
            jenisKelamin: form.modal_jenisKelamin.value,
            umurHewan: form.modal_umurHewan.value,
            hr: form.modal_hr.value,
            rr: form.modal_rr.value,
            suhu: form.modal_suhu.value,
            bb: form.modal_bb.value,
            crt: form.modal_crt.value,
            mukosa: form.modal_mukosa.value,
            turgor: form.modal_turgor.value,
            tandaKlinis: form.modal_tandaKlinis.value,
            keteranganTambahan: form.modal_keteranganTambahan.value,
        };

        saveData();
        bootstrap.Modal.getInstance(document.getElementById('rekamMedisModal')).hide();
        renderRekamMedis();
        alert("Perubahan Rekam Medis berhasil disimpan!");
    }

    function deleteRekamMedis(id) {
        if (confirm("Apakah Anda yakin ingin menghapus Rekam Medis ini?")) {
            const rmToDelete = dataRekamMedis.find(r => r.id === id);
            
            // PERBAIKAN: Kurangi slot ruangan jika pasien yang dihapus menempati ruang
            if (rmToDelete.ruang) {
                const ruangIndex = dataRuang.findIndex(r => r.nama === rmToDelete.ruang);
                if (ruangIndex !== -1) {
                    dataRuang[ruangIndex].terisi = Math.max(0, dataRuang[ruangIndex].terisi - 1);
                }
            }

            dataRekamMedis = dataRekamMedis.filter(r => r.id !== id);
            saveData();
            renderRekamMedis();
            renderDashboard();
            alert("Rekam Medis berhasil dihapus.");
        }
    }
    
    // F. Ruang (CRUD Logic Baru)
    function renderRuang() {
        const content = `
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>Data Ruangan Klinik</h2>
                <button class="btn btn-primary-custom" onclick="openRuangModal()">
                    <i class="bi bi-plus-lg me-1"></i> Tambah Ruangan
                </button>
            </div>
            <hr>
            <p>Total Ruangan: ${dataRuang.length} | Total Kapasitas: ${dataRuang.reduce((sum, r) => sum + r.kapasitas, 0)} | Total Terisi: ${dataRuang.reduce((sum, r) => sum + r.terisi, 0)}</p>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Nama Ruangan</th>
                            <th>Kapasitas Total</th>
                            <th>Terisi</th>
                            <th>Slot Tersedia</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${dataRuang.map((r, index) => {
                            const available = r.kapasitas - r.terisi;
                            let statusBadge = '';
                            if (available === 0) {
                                statusBadge = '<span class="badge bg-danger">PENUH</span>';
                            } else if (available > 0 && r.terisi > 0) {
                                statusBadge = '<span class="badge bg-warning text-dark">TERPAKAI</span>';
                            } else {
                                statusBadge = '<span class="badge bg-success">TERSEDIA</span>';
                            }
                            
                            return `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${r.nama}</td>
                                    <td>${r.kapasitas}</td>
                                    <td>${r.terisi}</td>
                                    <td>${available}</td>
                                    <td>${statusBadge}</td>
                                    <td>
                                        <button class="btn btn-sm btn-info text-white" onclick="openRuangModal(${r.id})"><i class="bi bi-pencil"></i> Edit</button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteRuang(${r.id})"><i class="bi bi-trash"></i> Hapus</button>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;
        pageContent.innerHTML = content;
        setActiveLink('ruang');
    }

    function openRuangModal(idToEdit = null) {
        const modal = new bootstrap.Modal(document.getElementById('ruangModal'));
        const modalTitle = document.getElementById('ruangModalLabel');
        const ruangId = document.getElementById('ruangId');
        const namaRuang = document.getElementById('namaRuang');
        const kapasitasRuang = document.getElementById('kapasitasRuang');
        const terisiRuang = document.getElementById('terisiRuang');
        
        terisiRuang.disabled = false; // Enable terisiRuang input by default

        if (idToEdit) {
            const ruang = dataRuang.find(r => r.id === idToEdit);
            if (!ruang) return;

            modalTitle.textContent = 'Edit Ruangan: ' + ruang.nama;
            ruangId.value = ruang.id;
            namaRuang.value = ruang.nama;
            kapasitasRuang.value = ruang.kapasitas;
            terisiRuang.value = ruang.terisi;

            // Pastikan jumlah terisi tidak melebihi kapasitas
            kapasitasRuang.onchange = () => {
                if (parseInt(terisiRuang.value) > parseInt(kapasitasRuang.value)) {
                    terisiRuang.value = kapasitasRuang.value;
                }
            };
            terisiRuang.onchange = () => {
                if (parseInt(terisiRuang.value) > parseInt(kapasitasRuang.value)) {
                    alert("Jumlah terisi tidak boleh melebihi kapasitas!");
                    terisiRuang.value = kapasitasRuang.value;
                }
            };

        } else {
            modalTitle.textContent = 'Tambah Ruangan Baru';
            document.getElementById('formRuang').reset();
            ruangId.value = '';
        }
        modal.show();
    }

    function handleRuangSubmit(event) {
        event.preventDefault();

        const id = document.getElementById('ruangId').value;
        const nama = document.getElementById('namaRuang').value;
        const kapasitas = parseInt(document.getElementById('kapasitasRuang').value);
        let terisi = parseInt(document.getElementById('terisiRuang').value);
        
        if (terisi > kapasitas) {
            alert("Jumlah terisi tidak boleh melebihi kapasitas!");
            return;
        }

        if (id) {
            // Edit
            const index = dataRuang.findIndex(r => r.id === parseInt(id));
            if (index !== -1) {
                dataRuang[index] = { ...dataRuang[index], nama, kapasitas, terisi };
            }
            alert("Data Ruangan berhasil diubah!");
        } else {
            // Tambah Baru
            const newId = dataRuang.length > 0 ? Math.max(...dataRuang.map(r => r.id)) + 1 : 1;
            dataRuang.push({ id: newId, nama, kapasitas, terisi });
            alert("Data Ruangan berhasil ditambahkan!");
        }
        
        saveData();
        bootstrap.Modal.getInstance(document.getElementById('ruangModal')).hide();
        renderRuang();
        renderDashboard();
    }

    function deleteRuang(id) {
        if (confirm("Apakah Anda yakin ingin menghapus Ruangan ini?")) {
            const ruangToDelete = dataRuang.find(r => r.id === id);
            
            if (ruangToDelete && ruangToDelete.terisi > 0) {
                if (!confirm(`Peringatan: Ruangan ${ruangToDelete.nama} sedang terisi (${ruangToDelete.terisi} slot). Hapus akan membuat data rekam medis yang merujuk ke ruang ini kehilangan referensi. Lanjutkan?`)) {
                    return;
                }
            }
            
            dataRuang = dataRuang.filter(r => r.id !== id);
            saveData();
            renderRuang();
            renderDashboard();
            alert("Ruangan berhasil dihapus.");
        }
    }

    // G. Laporan
    function renderLaporan() {
        const content = `
            <h2>Laporan Rekam Medis</h2>
            <hr>
            <p>Pilih rentang waktu untuk mengunduh laporan Rekam Medis:</p>
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="startDate" class="form-label">Tanggal Mulai</label>
                    <input type="date" class="form-control" id="startDate">
                </div>
                <div class="col-md-4">
                    <label for="endDate" class="form-label">Tanggal Akhir</label>
                    <input type="date" class="form-control" id="endDate">
                </div>
                <div class="col-md-4 align-self-end">
                    <button class="btn btn-success w-100" onclick="downloadReport()">
                        <i class="bi bi-download me-2"></i> Unduh Laporan
                    </button>
                </div>
            </div>
            <div class="mt-4">
                <button class="btn btn-outline-primary me-2" onclick="setReportRange(7)">1 Minggu Terakhir</button>
                <button class="btn btn-outline-primary me-2" onclick="setReportRange(30)">1 Bulan Terakhir</button>
            </div>
            <p class="text-muted mt-4">Catatan: Proses unduhan ini adalah simulasi. Dalam aplikasi nyata, ini akan menghasilkan file PDF/Excel.</p>
        `;
        pageContent.innerHTML = content;
        setActiveLink('laporan');
    }

    function setReportRange(days) {
        const today = new Date();
        const start = new Date(today);
        start.setDate(today.getDate() - days);

        document.getElementById('endDate').value = today.toISOString().substring(0, 10);
        document.getElementById('startDate').value = start.toISOString().substring(0, 10);
        alert(`Rentang waktu diatur ke ${days} hari terakhir.`);
    }

    function downloadReport() {
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        
        if (!start || !end) {
            return alert("Mohon pilih tanggal mulai dan tanggal akhir.");
        }

        const filteredData = dataRekamMedis.filter(r => 
            r.tglPeriksa >= start && r.tglPeriksa <= end
        );

        alert(`Simulasi Unduh Laporan:\nRentang: ${start} sampai ${end}\nJumlah Data Ditemukan: ${filteredData.length} entri.\n\n(Laporan akan diunduh dalam format PDF/Excel di sistem nyata.)`);
    }

    // --- Inisialisasi Navigasi ---
    const pageMap = {
        'dashboard': renderDashboard,
        'dokter': renderDokter,
        'pasien': renderPasien,
        'ruang': renderRuang,
        'rekam-medis': renderRekamMedis,
        'laporan': renderLaporan
    };

    document.querySelectorAll('.sidebar .nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const page = this.getAttribute('data-page');
            pageMap[page]();
        });
    });
</script>
</body>
</html>